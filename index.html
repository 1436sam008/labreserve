<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lab Reserve — Lab Manager</title>
  <style>
    /* (your existing CSS unchanged) */
    .view { display: none; }
    .active-view { display: block; }
    :root{--bg:#f5f7fb;--card:#ffffff;--muted:#8b95a1;--accent:#6f42c1;--accent-2:#7c4dff;--success:#1db954;--danger:#e55353}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;color:#222;background:linear-gradient(180deg,#f6f8fb 0%, #eef2f8 100%)}
    .app{display:flex;min-height:100vh}
    .sidebar{width:260px;background:#151428;color:#fff;display:flex;flex-direction:column;padding:18px;gap:18px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff}
    .brand h2{font-size:16px;margin:0}
    .nav{margin-top:6px;display:flex;flex-direction:column;gap:6px}
    .nav button{background:transparent;border:none;color:#bfc7d6;text-align:left;padding:10px;border-radius:8px;cursor:pointer;font-weight:600}
    .nav button.active{background:linear-gradient(90deg, rgba(124,77,255,0.12), rgba(111,66,193,0.08));color:#fff}
    .nav small{display:block;color:var(--muted);font-weight:500}
    .main{flex:1;padding:18px}
    .topbar{display:flex;justify-content:space-between;gap:12px;align-items:center;margin-bottom:14px}
    .search{display:flex;gap:8px;align-items:center}
    .search input{padding:10px 12px;border-radius:10px;border:1px solid #e6e9f0;background:white;min-width:260px}
    .actions{display:flex;gap:8px}
    .btn{background:var(--accent);color:#fff;padding:9px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:600}
    .btn.ghost{background:transparent;border:1px solid rgba(20,20,40,0.06);color:#222}
    .small{font-size:12px;color:var(--muted)}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(20,20,40,0.04)}
    .stats{grid-column:span 12;display:flex;gap:12px;align-items:stretch}
    .stat{flex:1;padding:16px;border-radius:12px;display:flex;flex-direction:column;justify-content:space-between}
    .stat .value{font-size:20px;font-weight:700}
    .stat .label{color:var(--muted);font-size:13px}
    .stat.purple{background:linear-gradient(180deg,#6f42c1 0%, #7c4dff 100%);color:#fff}
    .panel-left{grid-column:span 8}
    .panel-right{grid-column:span 4}
    .shifts{display:flex;gap:8px;margin-top:12px}
    .shift{flex:1;padding:12px;border-radius:10px;display:flex;align-items:center;gap:12px}
    .shift .count{font-size:18px;font-weight:700}
    .shift .text{font-size:12px;color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 8px;border-bottom:1px solid #f0f2f6;text-align:left;font-size:14px}
    th{color:var(--muted);font-weight:700}
    .tag{display:inline-block;padding:6px 8px;border-radius:999px;font-size:12px}
    .tag.green{background:#e6fbef;color:#117a3b}
    .tag.red{background:#fff2f2;color:#a12d2d}
    .manager .item{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:10px}
    .manager .item + .item{margin-top:8px}
    .modal-backdrop{position:fixed;inset:0;background:rgba(18,18,24,0.4);display:flex;align-items:center;justify-content:center;z-index:9999}
    .modal{width:720px;background:var(--card);border-radius:12px;padding:18px}
    .form-row{display:flex;gap:8px}
    .form-row input,select{flex:1;padding:8px;border-radius:8px;border:1px solid #e6e9f0}
    .view { display: none; } 
    .view.active { display: block; } 
    footer{margin-top:18px;color:var(--muted);font-size:13px}
    /* ORIGINAL MEDIA QUERY REPLACED BY MOBILE OVERLAY STYLES BELOW */
  </style>

  <!-- Firebase (compat) scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <!-- added close X inside brand (hidden on desktop, shown on mobile) -->
      <div class="brand" style="position:relative; padding-right:36px;">
        <div class="logo">LR</div>
        <div>
          <h2>Lab Reserve</h2>
          <small style="color:#bfc7d6">Seat Reservation</small>
        </div>
        <button id="sidebarClose" aria-label="Close menu" style="position:absolute; right:8px; top:8px; display:none; background:transparent; border:none; font-size:20px; cursor:pointer;">✕</button>
      </div>
      <nav class="nav" id="sidebarNav">
        <button class="active" data-view="dashboard">Dashboard</button>
        <button data-view="students">Student Profiles</button>
        <button data-view="reminders">Reminder Trackers</button>
        <button data-view="payments">Payment Records</button>
        <button data-view="shifts">Shift Config</button>
      </nav>
      <div style="margin-top:auto;color:#a9b3c3;font-size:13px">Manager: <strong id="mgrName">Admin</strong></div>
    </aside>

    <main class="main">
      <div class="topbar">
        <!-- MOBILE: hamburger button -->
        <button class="mobile-menu-btn" id="menuBtn" aria-label="Open menu" style="display:none">☰</button>

        <div class="search">
          <input id="q" placeholder="Search students by name or mobile" />
          <div style="color:var(--muted);font-weight:600">|</div>
          <div style="color:var(--muted);font-size:13px">Today: <span id="today"></span></div>
        </div>
        <div class="actions">
          <div id="userStatus" class="small" style="min-width:180px;text-align:right">Firebase: initializing...</div>
          <button class="btn ghost" id="btnAuth">Sign in</button>
          <button class="btn ghost" id="btnSaveCloud">Save Cloud</button>
          <button class="btn ghost" id="btnLoadCloud">Load Cloud</button>
          <button class="btn ghost" id="importBtn">Import</button>
          <button class="btn ghost" id="exportBtn">Export</button>
          <button class="btn" id="addBtn">Add Student</button>
        </div>
      </div>

      <!-- (rest of your HTML unchanged) -->
      <section id="view-dashboard" class="view active">
        <div class="grid">
          <div class="stats card">
            <div class="stat purple">
              <div class="label">Total Amount Paid</div>
              <div class="value" id="statPaid">₹ 0</div>
            </div>
            <div class="stat" style="background:linear-gradient(180deg,#fff 0,#fcfbff 100%)">
              <div class="label">Total Monthly Fees</div>
              <div class="value" id="statMonthly">₹ 0</div>
            </div>
            <div class="stat" style="background:linear-gradient(180deg,#fff 0,#fcfbff 100%)">
              <div class="label">Total Students</div>
              <div class="value" id="statStudents">0</div>
            </div>
            <div class="stat" style="background:linear-gradient(180deg,#fff 0,#fcfbff 100%)">
              <div class="label">Reminders Today</div>
              <div class="value" id="statReminders">0</div>
            </div>
          </div>

          <div class="panel-left card">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <h3 style="margin:0">Students</h3>
              <div style="display:flex;gap:8px;align-items:center">
                <select id="filterPaid"><option value="all">All</option><option value="paid">Paid</option><option value="unpaid">Unpaid</option></select>
                <select id="filterShift"><option value="all">All Shifts</option><option value="half-7-15">Half A (7-15)</option><option value="half-15-22">Half B (15-22)</option><option value="full-7-22">Full (7-22)</option></select>
              </div>
            </div>

            <div class="shifts" style="margin-top:12px">
              <div class="shift" style="background:#f0f9f4"><div><div class="count" id="countA">0</div><div class="text">Half-time Shift A</div></div></div>
              <div class="shift" style="background:#fff6f6"><div><div class="count" id="countB">0</div><div class="text">Half-time Shift B</div></div></div>
              <div class="shift" style="background:#eef7ff"><div><div class="count" id="countFull">0</div><div class="text">Full-time</div></div></div>
              <div class="shift" style="background:#fff9ed"><div><div class="count" id="countTotal">0</div><div class="text">Total Seats</div></div></div>
            </div>

            <div style="margin-top:12px;overflow:auto;max-height:440px">
              <table id="studentsTable">
                <thead><tr><th>Name</th><th>Shift</th><th>Fee</th><th>Status</th><th>Next Due</th><th>Joined</th><th></th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <aside class="panel-right card manager">
            <h4 style="margin-top:0">Manager Panel</h4>
            <div class="item" style="background:linear-gradient(90deg,#fff,#fbfbff)">
              <div>
                <div style="font-weight:700">Reminders</div>
                <div class="small" style="color:var(--muted)" id="reminderList">No reminders today</div>
              </div>
              <div>
                <button class="btn" id="collectAll">Collect</button>
              </div>
            </div>
            <div style="height:12px"></div>
            <div class="item">
              <div>
                <div style="font-weight:700">Trash</div>
                <div class="small" style="color:var(--muted)" id="trashCount">0 removed</div>
              </div>
              <div>
                <button class="btn ghost" id="openTrash">Open</button>
              </div>
            </div>
            <div style="height:12px"></div>
            <div class="item">
              <div>
                <div style="font-weight:700">Reports</div>
                <div class="small" style="color:var(--muted)">Monthly CSV & Summary</div>
              </div>
              <div style="display:flex;flex-direction:column;gap:6px">
                <button class="btn" id="monthlyReport">CSV</button>
                <button class="btn ghost" id="summaryReport">Summary</button>
              </div>
            </div>
            <footer>Tip: This app stores data locally. Use Export to backup.</footer>
          </aside>
        </div>
      </section>

      <!-- other sections unchanged... -->
      <section id="view-students" class="view">
        <div class="card">
          <h3>Student Profiles</h3>
          <div style="margin-top:8px">
            <table id="studentsTable_studentsView">
              <thead><tr><th>Name</th><th>Phone</th><th>Shift</th><th>Fee</th><th>Next Due</th><th>Status</th><th>Actions</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="view-reminders" class="view">
        <div class="card">
          <h3>Reminders This Month</h3>
          <div id="remindersListContainer" style="margin-top:12px"></div>
        </div>
      </section>

      <section id="view-payments" class="view">
        <div class="card">
          <h3>Payments</h3>
          <div id="paymentsListContainer" style="margin-top:12px"></div>
        </div>
      </section>

      <section id="view-shifts" class="view">
        <div class="card">
          <h3>Shift Configuration</h3>
          <p class="small" style="color:var(--muted)">Edit shifts (simple labels) — this demo keeps static shift IDs. You can extend to add custom shifts.</p>
          <div style="margin-top:12px">
            <div><strong>Half A (7:00-15:00)</strong></div>
            <div><strong>Half B (15:00-22:00)</strong></div>
            <div><strong>Full (7:00-22:00)</strong></div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <div id="modalRoot"></div>

<script>
/* =========================
   Firebase setup & helpers
   ========================= */

/**
 *  IMPORTANT: Paste your firebaseConfig object below.
 */
const firebaseConfig = {
  apiKey: "AIzaSyAazGHrV1YjB1t_NnYNppShKXNuVvG33MY",
  authDomain: "lab-reserve-18c9c.firebaseapp.com",
  projectId: "lab-reserve-18c9c",
  storageBucket: "lab-reserve-18c9c.firebasestorage.app",
  messagingSenderId: "712919141440",
  appId: "1:712919141440:web:f8908b99ae6ed631c4a3a5",
  measurementId: "G-3BYS2MWMJ6"
};


let firebaseReady = false;
let db = null;
let auth = null;
let currentUser = null;
let _cloudWriteLock = false; // prevent loops

function initFirebaseIfPossible() {
  if(!window.firebase) {
    document.getElementById('userStatus').textContent = 'Firebase: SDK not loaded';
    return;
  }
  try {
    if(!firebase.apps.length && firebaseConfig && Object.keys(firebaseConfig).length>0) {
      firebase.initializeApp(firebaseConfig);
    }
    auth = firebase.auth();
    db = firebase.firestore();
    firebaseReady = true;
    document.getElementById('userStatus').textContent = 'Firebase: ready (signed out)';
    // listen to auth state changes
    auth.onAuthStateChanged(u => {
      currentUser = u;
      if(u) {
        document.getElementById('userStatus').textContent = 'Signed in: ' + (u.displayName || u.email || u.uid);
        document.getElementById('btnAuth').textContent = 'Sign out';
        // start realtime cloud sync (merge)
        startRealtimeSync();
      } else {
        document.getElementById('userStatus').textContent = 'Signed out';
        document.getElementById('btnAuth').textContent = 'Sign in';
        // detach realtime listener if present
        if(window._studentsUnsub) { try { window._studentsUnsub(); } catch(e){} window._studentsUnsub = null; }
      }
    });
  } catch(err) {
    console.error('Firebase init error', err);
    document.getElementById('userStatus').textContent = 'Firebase init error';
  }
}

/**
 * Save a single student doc to Firestore (merge)
 */
async function saveStudentToFirestore(student) {
  if(!db || !currentUser) return;
  if(!student || !student.id) return;
  try {
    _cloudWriteLock = true;
    const copy = Object.assign({}, student);
    await db.collection('students').doc(String(copy.id)).set(copy, { merge: true });
  } catch (e) {
    console.error('saveStudentToFirestore', e);
  } finally {
    setTimeout(()=> { _cloudWriteLock = false; }, 250);
  }
}

/**
 * Save all local students to Firestore (batched)
 */
async function saveAllToFirestore() {
  if(!db || !currentUser) return;
  try {
    const batch = db.batch();
    (state.students || []).forEach(s => {
      const ref = db.collection('students').doc(String(s.id));
      batch.set(ref, s, { merge: true });
    });
    _cloudWriteLock = true;
    await batch.commit();
  } catch(e) { console.error('saveAllToFirestore', e); }
  finally { setTimeout(()=> { _cloudWriteLock = false; }, 300); }
}

/**
 * Load & merge students from Firestore into local state (cloud wins for same id)
 */
async function loadFromFirestore() {
  if(!db) return alert('Firestore not initialized');
  try {
    const snap = await db.collection('students').get();
    const cloud = [];
    snap.forEach(doc => {
      const d = doc.data() || {};
      d.id = String(d.id || doc.id);
      cloud.push(d);
    });
    if(cloud.length === 0) { alert('No students found in Firestore.'); return; }
    const localMap = new Map((state.students||[]).map(s => [s.id,s]));
    cloud.forEach(c => localMap.set(c.id, c));
    state.students = Array.from(localMap.values());
    save(); renderAll();
    alert(`Loaded ${cloud.length} students from cloud (merged).`);
  } catch(e) { console.error('loadFromFirestore', e); alert('Load failed: '+(e.message||e)); }
}

/**
 * Start a realtime listener that merges cloud changes into local state (cloud wins same id).
 */
function startRealtimeSync() {
  if(!db) return console.warn('Firestore not initialized');
  if(window._studentsUnsub) { try { window._studentsUnsub(); } catch(e){} window._studentsUnsub = null; }
  window._studentsUnsub = db.collection('students')
    .onSnapshot(snapshot => {
      if(_cloudWriteLock) return;
      const cloudArr = [];
      snapshot.forEach(doc => {
        const d = doc.data() || {};
        d.id = String(d.id || doc.id);
        cloudArr.push(d);
      });
      const localMap = new Map((state.students||[]).map(s=>[s.id,s]));
      cloudArr.forEach(c => localMap.set(c.id, c));
      const merged = Array.from(localMap.values());
      let needUpdate = merged.length !== (state.students||[]).length;
      if(!needUpdate) {
        for(let i=0;i<merged.length;i++){
          if(!state.students[i] || state.students[i].id !== merged[i].id) { needUpdate = true; break; }
        }
      }
      if(needUpdate) {
        state.students = merged;
        save(); renderAll();
        console.log('Realtime: merged cloud -> local, total:', state.students.length);
      } else {
        state.students = merged;
        renderAll();
      }
    }, error => {
      console.error('Realtime snapshot error', error);
    });
}

/* =========================
   End Firebase helpers
   ========================= */

/* --- App state & helpers (UNCHANGED except autosave removed) --- */
const KEY = 'lab_v2';
let state = { students: [], trash: [] };
const today = new Date();
document.getElementById('today').textContent = today.toLocaleDateString();

function uid(){return 's_' + Math.random().toString(36).slice(2,9);}

/**
 * save() now only writes to localStorage (autosave removed).
 * Cloud saves remain manual via Save Cloud button or explicit saveStudentToFirestore calls.
 */
function save(){
  localStorage.setItem(KEY, JSON.stringify(state));
  // AUTOSAVE TO CLOUD REMOVED: cloud writes now only occur on explicit Save Cloud or per-item calls.
}

function load(){ const raw = localStorage.getItem(KEY); if(raw) { try { state = JSON.parse(raw); } catch(e){ state = { students: [], trash: [] }; } } renderAll(); }

/* --- rest of your original JS unchanged --- */

// Month helpers
function getMonthKey(d){ const dt = new Date(d); return dt.getFullYear() + '-' + String(dt.getMonth()+1).padStart(2,'0'); }
function currentMonthKey(){ return getMonthKey(new Date()); }
function isPaidThisMonth(s){
  const m = currentMonthKey();
  return (s.payments || []).some(p => String(p.monthFor) === m);
}
function shiftLabel(k){ if(k==='half-7-15') return 'Half A (7:00-15:00)'; if(k==='half-15-22') return 'Half B (15:00-22:00)'; return 'Full (7:00-22:00)'; }
function escapeHtml(s){ return (s||'').toString().replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }

// Next due helper
function computeNextDue(student){
  let dueDay = 1;
  if(student.joinDate){
    const jd = new Date(student.joinDate);
    if(!isNaN(jd)) dueDay = jd.getDate() || 1;
  }
  const now = new Date();
  let candidate = new Date(now.getFullYear(), now.getMonth(), dueDay);
  const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  if(candidate < todayStart){
    let m = now.getMonth() + 1;
    let y = now.getFullYear();
    if(m > 11){ m = 0; y += 1; }
    candidate = new Date(y, m, dueDay);
  }
  const diffDays = Math.ceil((candidate - todayStart) / (24*60*60*1000));
  const y = candidate.getFullYear(), mo = String(candidate.getMonth()+1).padStart(2,'0'), d = String(candidate.getDate()).padStart(2,'0');
  return { date: `${y}-${mo}-${d}`, daysLeft: diffDays };
}

// View switching
const nav = document.getElementById('sidebarNav');
nav.addEventListener('click', (ev) => {
  const btn = ev.target.closest('button[data-view]');
  if(!btn) return;
  const view = btn.getAttribute('data-view');
  switchView(view);
});

function switchView(viewName){
  nav.querySelectorAll('button[data-view]').forEach(b => b.classList.toggle('active', b.getAttribute('data-view') === viewName));
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  const target = document.getElementById('view-' + viewName);
  if(target) target.classList.add('active');
  if(viewName === 'students') populateStudentsViewTable();
  if(viewName === 'reminders') populateRemindersView();
  if(viewName === 'payments') populatePaymentsView();
  if(viewName === 'dashboard') renderStats();
}

// Rendering
function renderAll(){ renderStats(); renderTable(); renderManager(); populateStudentsViewTable(); populateRemindersView(); populatePaymentsView(); }

function renderStats(){
  const totalStudents = state.students.length;
  const totalMonthly = state.students.reduce((a,s)=>a+(s.fee||0),0);
  const totalPaid = state.students.flatMap(s=>s.payments||[]).reduce((a,p)=>a+(p.amount||0),0);
  document.getElementById('statStudents').textContent = totalStudents;
  document.getElementById('statMonthly').textContent = '₹ '+totalMonthly;
  document.getElementById('statPaid').textContent = '₹ '+totalPaid;

  const countA = state.students.filter(s=>s.shift==='half-7-15').length;
  const countB = state.students.filter(s=>s.shift==='half-15-22').length;
  const countFull = state.students.filter(s=>s.shift==='full-7-22').length;
  document.getElementById('countA').textContent = countA;
  document.getElementById('countB').textContent = countB;
  document.getElementById('countFull').textContent = countFull;
  document.getElementById('countTotal').textContent = totalStudents;

  const rem = state.students.filter(s => (s.status || 'Active') === 'Active' && !isPaidThisMonth(s));
  document.getElementById('statReminders').textContent = rem.length;
  const remList = document.getElementById('reminderList');
  if(rem.length === 0) remList.textContent = 'No reminders today';
  else remList.textContent = rem.map(r => r.name + ' (' + shiftLabel(r.shift) + ')').join(', ');
}

function renderTable(){
  const tbody = document.querySelector('#studentsTable tbody'); tbody.innerHTML='';
  const q = (document.getElementById('q').value||'').toLowerCase();
  const fPaid = document.getElementById('filterPaid').value; const fShift = document.getElementById('filterShift').value;
  state.students.forEach(s=>{
    if(q && !(s.name.toLowerCase().includes(q) || (s.mobile||'').includes(q) || (s.parentMobile||'').includes(q))) return;
    if(fShift!=='all' && s.shift!==fShift) return;
    const paid = isPaidThisMonth(s);
    if(fPaid==='paid' && !paid) return; if(fPaid==='unpaid' && paid) return;

    const next = computeNextDue(s);
    const nextStr = next ? `${next.date} (${next.daysLeft}d)` : '';

    const tr = document.createElement('tr');
    tr.innerHTML = `<td><strong>${escapeHtml(s.name)}</strong><div style="color:var(--muted);font-size:12px">${escapeHtml(s.mobile||'')}</div></td>
      <td>${shiftLabel(s.shift)}</td>
      <td>₹ ${s.fee||0}</td>
      <td>${paid? '<span class="tag green">PAID</span>':'<span class="tag red">DUE</span>'}</td>
      <td>${nextStr}</td>
      <td>${s.joinDate||''}</td>
      <td style="text-align:right"><button class="btn small" data-act="collect" data-id="${s.id}">Collect</button> <button class="btn ghost small" data-act="view" data-id="${s.id}">View</button> <button class="btn ghost small" data-act="history" data-id="${s.id}">History</button> <button class="btn ghost small" data-act="remove" data-id="${s.id}">Trash</button></td>`;
    tbody.appendChild(tr);
  });
}

function renderManager(){ document.getElementById('trashCount').textContent = state.trash.length+' removed'; }

function populateStudentsViewTable(){
  const tbody = document.querySelector('#studentsTable_studentsView tbody'); if(!tbody) return; tbody.innerHTML = '';
  state.students.forEach(s => {
    const paid = isPaidThisMonth(s);
    const next = computeNextDue(s);
    const nextStr = next ? `${next.date} (${next.daysLeft}d)` : '';
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(s.name)}</td><td>${escapeHtml(s.mobile||'')}</td><td>${shiftLabel(s.shift)}</td><td>₹ ${s.fee||0}</td><td>${nextStr}</td><td>${paid? 'PAID':'DUE'}</td><td><button class="btn" data-id="${s.id}" data-act="view">View</button> <button class="btn ghost" data-id="${s.id}" data-act="collect">Collect</button></td>`;
    tbody.appendChild(tr);
  });
}

function populateRemindersView(){
  const container = document.getElementById('remindersListContainer'); if(!container) return;
  const m = currentMonthKey();
  const list = state.students.filter(s => (s.status||'Active') === 'Active' && !isPaidThisMonth(s));
  if(list.length===0) { container.innerHTML = '<div class="small" style="color:var(--muted)">No reminders this month</div>'; return; }
  const html = list.map(s => {
    const last = (s.payments||[]).slice(-1)[0];
    return `<div style="padding:10px;border-bottom:1px solid #f2f4f8;display:flex;justify-content:space-between;align-items:center">
      <div><strong>${escapeHtml(s.name)}</strong><div class="small">${escapeHtml(s.mobile||'')}</div></div>
      <div style="text-align:right"><div class="small">Due: ₹ ${s.fee||0}</div><button class="btn" data-id="${s.id}" data-act="collect">Collect</button></div>
    </div>`;
  }).join('');
  container.innerHTML = html;
}

function populatePaymentsView(){
  const container = document.getElementById('paymentsListContainer'); if(!container) return;
  if(state.students.length===0){ container.innerHTML = '<div class="small" style="color:var(--muted)">No students / payments</div>'; return; }
  const html = state.students.map(s => {
    const total = (s.payments||[]).reduce((a,p)=>a+(p.amount||0),0);
    const last = (s.payments||[]).slice(-1)[0];
    const lastDate = last ? last.date.slice(0,10) : 'Never';
    return `<div style="padding:10px;border-bottom:1px solid #f4f6fb;display:flex;justify-content:space-between;align-items:center">
      <div><button class="btn ghost" onclick="openPaymentHistory('${s.id}')">${escapeHtml(s.name)}</button><div class="small" style="color:var(--muted)">${escapeHtml(s.mobile||'')}</div></div>
      <div style="text-align:right"><div style="font-weight:700">₹ ${total}</div><div class="small">${lastDate}</div></div>
    </div>`;
  }).join('');
  container.innerHTML = html;
}

// Event wiring for controls
document.getElementById('addBtn').onclick = ()=>openStudentModal();
document.getElementById('exportBtn').onclick = ()=>exportData();
document.getElementById('importBtn').onclick = ()=>importData();
document.getElementById('q').addEventListener('input',renderTable);
document.getElementById('filterPaid').addEventListener('change',renderTable);
document.getElementById('filterShift').addEventListener('change',renderTable);
document.getElementById('monthlyReport').onclick = generateCSV;
document.getElementById('summaryReport').onclick = ()=>{ const m=currentMonthKey(); const total=state.students.length; const paid=state.students.filter(s=>(s.payments||[]).some(p=>p.monthFor===m)).length; const revenue=state.students.flatMap(s=>s.payments||[]).filter(p=>p.monthFor===m).reduce((a,p)=>a+p.amount,0); alert(`Summary ${m}:\nTotal students: ${total}\nPaid: ${paid}\nRevenue: ₹ ${revenue}`); };

document.addEventListener('click', e => {
  const b = e.target.closest('button[data-act]');
  if(!b) return;
  const act = b.dataset.act; const id = b.dataset.id;
  if(act==='collect') openCollectModal(id);
  if(act==='view') openStudentModal(id, true);
  if(act==='history') openHistoryModal(id);
  if(act==='remove') { if(confirm('Move to trash?')) moveToTrash(id); }
});

// Modals & CRUD (unchanged) - code omitted here for brevity in this snippet block (it's the same as your original)
... (same as you provided) ...
// Note: above "..." denotes all the unchanged modal and CRUD functions present earlier in your file
// (In the actual file these functions are intact as you provided them.)
